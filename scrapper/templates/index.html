<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تحميل فيديوهات YouTube</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fab fa-youtube"></i> تحميل فيديوهات اليوتيوب</h1>
            <p>قم بلصق رابط الفيديو وسنقوم بتحميله لك</p>
        </header>

        <main>
            <div class="input-section">
                <div class="url-input">
                    <input type="text" id="videoUrl" placeholder="أدخل رابط فيديو اليوتيوب هنا..." />
                    <button id="getInfoBtn" onclick="getVideoInfo()">
                        <i class="fas fa-search"></i> البحث عن الفيديو
                    </button>
                </div>
            </div>

            <div id="loading" class="loading hidden">
                <div class="loader">
                    <div class="truckWrapper">
                        <div class="truckBody">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 198 93" class="trucksvg">
                                <path stroke-width="3" stroke="#282828" fill="#F83D3D" d="M135 22.5H177.264C178.295 22.5 179.22 23.133 179.594 24.0939L192.33 56.8443C192.442 57.1332 192.5 57.4404 192.5 57.7504V89C192.5 90.3807 191.381 91.5 190 91.5H135C133.619 91.5 132.5 90.3807 132.5 89V25C132.5 23.6193 133.619 22.5 135 22.5Z"></path>
                                <path stroke-width="3" stroke="#282828" fill="#7D7C7C" d="M146 33.5H181.741C182.779 33.5 183.709 34.1415 184.078 35.112L190.538 52.112C191.16 53.748 189.951 55.5 188.201 55.5H146C144.619 55.5 143.5 54.3807 143.5 53V36C143.5 34.6193 144.619 33.5 146 33.5Z"></path>
                                <path stroke-width="2" stroke="#282828" fill="#282828" d="M150 65C150 65.39 149.763 65.8656 149.127 66.2893C148.499 66.7083 147.573 67 146.5 67C145.427 67 144.501 66.7083 143.873 66.2893C143.237 65.8656 143 65.39 143 65C143 64.61 143.237 64.1344 143.873 63.7107C144.501 63.2917 145.427 63 146.5 63C147.573 63 148.499 63.2917 149.127 63.7107C149.763 64.1344 150 64.61 150 65Z"></path>
                                <rect stroke-width="2" stroke="#282828" fill="#FFFCAB" rx="1" height="7" width="5" y="63" x="187"></rect>
                                <rect stroke-width="2" stroke="#282828" fill="#282828" rx="1" height="11" width="4" y="81" x="193"></rect>
                                <rect stroke-width="3" stroke="#282828" fill="#DFDFDF" rx="2.5" height="90" width="121" y="1.5" x="6.5"></rect>
                                <rect stroke-width="2" stroke="#282828" fill="#DFDFDF" rx="2" height="4" width="6" y="84" x="1"></rect>
                            </svg>
                        </div>
                        <div class="truckTires">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                                <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                                <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                                <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                                <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
                            </svg>
                        </div>
                        <div class="road"></div>
                        <svg xml:space="preserve" viewBox="0 0 453.459 453.459" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="Capa_1" version="1.1" fill="#000000" class="lampPost">
                            <path d="M252.882,0c-37.781,0-68.686,29.953-70.245,67.358h-6.917v8.954c-26.109,2.163-45.463,10.011-45.463,19.366h9.993c-1.65,5.146-2.507,10.54-2.507,16.017c0,28.956,23.558,52.514,52.514,52.514c28.956,0,52.514-23.558,52.514-52.514c0-5.478-0.856-10.872-2.506-16.017h9.992c0-9.354-19.352-17.204-45.463-19.366v-8.954h-6.149C200.189,38.779,223.924,16,252.882,16c29.952,0,54.32,24.368,54.32,54.32c0,28.774-11.078,37.009-25.105,47.437c-17.444,12.968-37.216,27.667-37.216,78.884v113.914h-0.797c-5.068,0-9.174,4.108-9.174,9.177c0,2.844,1.293,5.383,3.321,7.066c-3.432,27.933-26.851,95.744-8.226,115.459v11.202h45.75v-11.202c18.625-19.715-4.794-87.527-8.227-115.459c2.029-1.683,3.322-4.223,3.322-7.066c0-5.068-4.107-9.177-9.176-9.177h-0.795V196.641c0-43.174,14.942-54.283,30.762-66.043c14.793-10.997,31.559-23.461,31.559-60.277C323.202,31.545,291.656,0,252.882,0zM232.77,111.694c0,23.442-19.071,42.514-42.514,42.514c-23.442,0-42.514-19.072-42.514-42.514c0-5.531,1.078-10.957,3.141-16.017h78.747C231.693,100.736,232.77,106.162,232.77,111.694z"></path>
                        </svg>
                    </div>
                </div>
                <p>جاري البحث عن الفيديو...</p>
            </div>

            <div id="downloadLoading" class="loading hidden">
                <div class="simple-download-loader">
                    <div class="download-spinner"></div>
                    <p>جاري تحميل الفيديو...</p>
                    <p style="font-size: 0.9rem; color: #666;">يرجى الانتظار، قد يستغرق التحميل بعض الوقت</p>
                </div>
            </div>

            <div id="error" class="error hidden"></div>
            
            <div id="success" class="success hidden"></div>

            <div id="videoInfo" class="video-info hidden">
                <div class="video-header">
                    <img id="thumbnail" src="" alt="صورة مصغرة للفيديو" />
                    <div class="video-details">
                        <h3 id="videoTitle"></h3>
                        <p id="videoDuration"></p>
                    </div>
                </div>

                <div class="formats-section">
                    <h4>اختر جودة التحميل:</h4>
                    <div id="formatsList" class="formats-list"></div>
                </div>
            </div>
        </main>

        <footer>
            <p>by mohamed islam </p>
        </footer>
    </div>

    <script>
        let currentVideoUrl = '';

        function getVideoInfo() {
            const url = document.getElementById('videoUrl').value.trim();
            if (!url) {
                showError('يرجى إدخال رابط الفيديو');
                return;
            }

            // إضافة مؤشر تحميل على الزر
            const button = document.getElementById('getInfoBtn');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري البحث...';
            button.disabled = true;

            showLoading();
            hideError();
            hideVideoInfo();

            fetch('/get_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('خطأ في الخادم: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                button.innerHTML = originalText;
                button.disabled = false;
                
                if (data.error) {
                    showError(data.error);
                } else {
                    currentVideoUrl = url;
                    displayVideoInfo(data);
                }
            })
            .catch(error => {
                hideLoading();
                button.innerHTML = originalText;
                button.disabled = false;
                showError('حدث خطأ في الاتصال: ' + error.message);
            });
        }

        function displayVideoInfo(videoInfo) {
            document.getElementById('thumbnail').src = videoInfo.thumbnail;
            document.getElementById('videoTitle').textContent = videoInfo.title;
            
            const duration = Math.floor(videoInfo.duration / 60);
            const seconds = videoInfo.duration % 60;
            document.getElementById('videoDuration').textContent = 
                `${duration}:${seconds.toString().padStart(2, '0')}`;

            const formatsList = document.getElementById('formatsList');
            formatsList.innerHTML = '';

            videoInfo.formats.forEach(format => {
                const formatDiv = document.createElement('div');
                formatDiv.className = 'format-item';
                
                let quality = 'Unknown';
                let qualityClass = 'quality-unknown';
                let additionalInfo = '';
                
                if (format.height > 0) {
                    quality = `${format.height}p`;
                    // تحديد لون الجودة
                    if (format.height >= 1080) qualityClass = 'quality-hd';
                    else if (format.height >= 720) qualityClass = 'quality-hd';
                    else if (format.height >= 480) qualityClass = 'quality-sd';
                    else qualityClass = 'quality-low';
                    
                    // إضافة معلومات إضافية
                    if (format.fps > 0) additionalInfo += ` ${format.fps}fps`;
                    if (format.width > 0) additionalInfo += ` ${format.width}×${format.height}`;
                } else if (format.type === 'audio') {
                    quality = format.display_name || 'صوت فقط';
                    qualityClass = 'quality-audio';
                }
                
                const size = format.filesize > 0 ? formatFileSize(format.filesize) : 'Unknown';
                const ext = format.ext.toUpperCase();
                
                formatDiv.innerHTML = `
                    <div class="format-info">
                        <span class="quality ${qualityClass}">${quality}</span>
                        <span class="extension">${ext}</span>
                        <span class="size">${size}</span>
                        ${additionalInfo ? `<span class="additional-info">${additionalInfo}</span>` : ''}
                    </div>
                    <button onclick="downloadVideo('${format.format_id}')" class="download-btn">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                `;
                
                formatsList.appendChild(formatDiv);
            });

            showVideoInfo();
        }

        function downloadVideo(formatId) {
            if (!currentVideoUrl) {
                showError('لا يوجد رابط فيديو صالح');
                return;
            }

            console.log('Starting download for format:', formatId);
            console.log('Video URL:', currentVideoUrl);

            // إظهار رسالة بدء التحميل
            showSuccess('جاري بدء التحميل...');
            
            // إنشاء رابط تحميل مباشر
            const downloadUrl = `/download`;
            
            // إنشاء iframe مخفي للتحميل
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.name = 'downloadFrame';
            
            // إنشاء form وإرساله للـ iframe
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = downloadUrl;
            form.target = 'downloadFrame';
            
            // إضافة البيانات
            const urlInput = document.createElement('input');
            urlInput.type = 'hidden';
            urlInput.name = 'url';
            urlInput.value = currentVideoUrl;
            
            const formatInput = document.createElement('input');
            formatInput.type = 'hidden';
            formatInput.name = 'format_id';
            formatInput.value = formatId;
            
            // إضافة العناصر للنموذج
            form.appendChild(urlInput);
            form.appendChild(formatInput);
            
            // إضافة iframe والنموذج للصفحة
            document.body.appendChild(iframe);
            document.body.appendChild(form);
            
            // إرسال النموذج
            form.submit();
            
            // تنظيف بعد التحميل
            setTimeout(() => {
                document.body.removeChild(iframe);
                document.body.removeChild(form);
            }, 5000);
            
            // إظهار رسالة نجاح
            showSuccess('تم بدء التحميل! تحقق من شريط التحميل في Chrome');
            setTimeout(() => hideSuccess(), 5000);
        }

        function showLoadingMessage(message) {
            const loadingDiv = document.getElementById('loading');
            loadingDiv.querySelector('p').textContent = message;
            loadingDiv.classList.remove('hidden');
        }

        function showSuccess(message) {
            // إضافة رسالة نجاح مؤقتة
            const successDiv = document.getElementById('success');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.classList.remove('hidden');
                
                // إزالة الرسالة بعد 3 ثواني
                setTimeout(() => {
                    if (successDiv && successDiv.parentNode) {
                        successDiv.classList.add('hidden');
                    }
                }, 3000);
            } else {
                console.error('Success element not found');
                // إنشاء رسالة مؤقتة بديلة
                alert(message);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            } else {
                console.error('Error element not found');
                alert('خطأ: ' + message);
            }
        }

        function hideError() {
            const errorDiv = document.getElementById('error');
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
        }

        function hideSuccess() {
            const successDiv = document.getElementById('success');
            if (successDiv) {
                successDiv.classList.add('hidden');
            }
        }

        function showVideoInfo() {
            document.getElementById('videoInfo').classList.remove('hidden');
        }

        function hideVideoInfo() {
            document.getElementById('videoInfo').classList.add('hidden');
        }

        // دعم Enter key
        document.getElementById('videoUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                getVideoInfo();
            }
        });
    </script>
</body>
</html>
